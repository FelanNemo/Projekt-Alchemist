<!doctype html>
<html>
<head>
	<title></title>
	<meta charset="utf-8">
	<script src="jquery-3.2.0.min.js"></script>
  <link rel="stylesheet" href="style.css">
	<script>
	/*
	Globale Variable der Optionen da diese Variable in unterschiedlichen Request benötigt wird
	*/
	var opt = [];

	/*
	Bei On Click auf den Button "Speocher Element" wird die Standard Funktion verhindert,
	außerdem werden die Values der einzelnen Felder gespeichert.
	Im Ersten for werden alle Selects der ID Number gezählt und in ein Array gespeichert.

	Auf den Klickt erfolt ein Ajax Request um die gespeicherten Daten zu übermitteln.
	Durch die Daten Übermittlung ist der Request ein Postrequest.
	Als Antwort erhält der Request ob die Daten gespeichert wurden oder nicht
	*/
	$(document).on( 'click', '#saveEle', function(e) {
		e.preventDefault();

		var gametyp = $('#gametype').val();
		var name = $('#name').val();
		var newGametyp = $('#gameName input').val();
		var elements = [];

		for(var i  = 0; i < $('#number select').length; i++){
			var element = $('#number select').get(i).value;
			elements.push(element);
		}

		$.ajax({
			url:'http://127.0.0.1:12345/addEle',
			method:'post',
			data: {
				gametyp: gametyp,
				newGametyp: newGametyp,
				result: name,
				elements: elements,
				bildName: name +'.png',
			}
		}).done(function (response) {
				console.log(response);
		}).fail(function (response) {
			console.log('Error', arguments);
		});
	});

	/*
	Bei On Change wird ein Element mit der ID number ein und ausgeblendet
	und je nach Gametyp die Optionen sich anpassen
	*/
	$(document).on('change','#gametype', function(e){
		e.preventDefault();

		if($(this).val()== "new"){
				$('#gameName').show();
		} else{
			$('#gameName').hide();
			for(var i in $('#number option')){
				$('#number option').remove();
			}
			sel($('#element'));
			console.log($('#number').children.length*1);
		}


	});

	/*
	Bei On Change wird ein Element mit der ID number ein und ausgeblendet
	*/
	$(document).on('change', '#eletyp', function(e){
		e.preventDefault();

		if($(this).val() == "combination"){
			$('#number').show();
		} else{
			$('#number').hide();
		}
	});

	/*
	Bei diesem On Change werden die Selects des Span mit der ID number erzeugt,
	var id soll den neuen Selects eine eindeutige ID zuweisen, diese ist eine Nummer
	dadurch das es sich um eine length angabe handelt wird diese mit jedem Element
	größer.

	Die Selects erhalten ein Data Attribut "data-selected" dieser soll verhindern das nach dem ersten
	ändern eines Selects immer neue Selects angefügt werden.
	Ein neues Select wird an ID number angefügt das geänderte Select bekommt sein Data Attribut auf 1
	gesetzt.
	Es wird die sel Funktion mit der eindeutigen ID aufgerufen
	*/
	$(document).on('change', '#number select', function(e){
			var id = $('#number').children('select').length*1;

			var sele = $('<select id="'+id+'" data-selected=0>')
			if($(this).val() != 'empty' && $(this).attr('data-selected') == '0'){
				sele.appendTo('#number');
				$(this).attr('data-selected', '1');
			}
			sel($('#'+id));
	});

	/*
	Funktion sel dient dazu Die Selcts für die Elemente zu erzeugen
	Die Funktion speichert den Gewählten Gametyp eines vorhanden Spieles,
	dieser Gespeicherte Typ wird an den Server gesendet.
	Parameter: elementID -> ist die ID des Elements

	Der Ajax Request ist ein Postrequest, da Daten übermittelt werden.
	Als Antwort kommt ein Objekt das alle Resultate zu dem gewählten Gametyp des games.json
	gespeichert hat.

	Im Donezweig des Request wird durch diese Antworten durchgezählt und für eine jede
	eine Option hinzugefügt, den Parameter der Funktion dient dazu dass die Optionen nur zu
	einem Select hinzugefügt werden.
	*/
	var sel = function (elementID) {
		var gametyp = $('#gametype').val();

		$.ajax({
			url:'http://127.0.0.1:12345/select',
			method:'post',
			data: {
				gametyp: gametyp
			}
		}).done(function (response) {
				console.log('Erzeugt die Options für die Gameauswahl');
				var empty = $('<option value=empty>');
				empty.html('Wähle ein Element');
				empty.appendTo(elementID);
				for(var i in response){
					op = $('<option value='+ response[i] +'>');
					op.html(response[i]);
					op.appendTo(elementID);
					opt.push(op);
				}
				opt = [];
		}).fail(function (response) {
			console.log('Error', arguments);
		});
	}

	/*
	Ajax Request zum abfragen wieviele Option das Select hat, da im games.json mehr als
	ein Alchemist Game gespeichert sein kann
	Der Request ist ein Getrequest, da einfach nur die Gametypen des games.json zurück kommen.
	Als Antwort kommt ein Objekt mit den Gametypen zurück, diese werden in der for Schleife
	des Donezweigs durch gezählt und für ein jeden Gametyp wird eine Option an das selct angehängt.
	Die Optionen bekommen den Value und Text aus der Antwort zum jeweiligen i
	*/
	$.ajax({
		url:'http://127.0.0.1:12345/gametype',
		method:'get',
		data: {}
	}).done(function (response) {
			console.log('Erzeugt die Options für die Gameauswahl');
			for(var i in response) {
				var option = $('<option value='+ response[i] +'>');
				option.html(response[i]);
				option.appendTo($('#gametype'));
			}
	}).fail(function (response) {
		console.log('Error', arguments);
	});

	/*
	On Ready bringe alle Elemente auf die gleiche Breite
	*/
	$(document).ready(function(){
		$('#number').hide();
		var w = $('#name').width() + 170 ;
		$('form').css({'width': w});
		$('#saveEle').css({'width': w});
		$('input').css({'width':'63%'})
		$('select').css({'width':'69%'});
	});
	</script>
</head>
<body>
	<form id="admin">
    <br>Gametype: <select id="gametype">
      <option value="new"> Neuen Spieltyp erstellen</option>
		</select>
		<br><span id="gameName">Gamename: <input  placeholder="Technik"></input></span>
		<br>Elementname: <input id="name" placeholder="Feuer"></input>
    <br>Elementtyp: <select id="eletyp">
      <option value="start"> Start Element </option>
      <option value="combination"> Kombinationselement </option>
		</select>

		<span id="number">
			<select id="element" data-selected="0">
		</select>

		</span>
		<br><button id="saveEle">Speicher Element</button>
	</form>
</body>
</html>
